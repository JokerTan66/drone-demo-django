{% extends "layouts/base.html" %}

{% load static %}

{% block title %} 直播画面 {% endblock %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
<style>
.content {
  background-image: url("{% static 'assets/img/live_bg.jpg' %}");
  background-size: cover; /* 使背景图片覆盖整个区域 */
  background-position: center; /* 背景图片居中对齐 */
  background-repeat: no-repeat; /* 防止背景图片重复 */
  height: 100vh; /* 使内容高度为视口高度 */
  margin: 0;
  position: relative; /* 使卡片容器可以使用绝对定位 */
}

.video-container {
  width: 100%;
  height: 100%;
  display: flex;
  justify-content: center; /* 居中对齐视频元素 */
  align-items: center; /* 垂直居中视频元素 */
}

.video-wrapper {
  width: 100%;
  height: 100%;
  display: flex;
  justify-content: center; /* 居中对齐视频元素 */
  align-items: center; /* 垂直居中视频元素 */
}

.video-element, .img-element {
  width: 100%;
  height: 100%;
  object-fit: cover; /* 保持视频和图片的比例 */
  cursor: pointer; /* 添加鼠标悬停效果 */
}

.video-element:hover, .img-element:hover {
  /* 鼠标悬停效果 */
}

.card-container {
  position: absolute; /* 绝对定位卡片容器 */
  top: 100px; /* 从顶部距离 */
  right: 20px; /* 从右侧距离 */
  display: flex;
  flex-direction: column; /* 垂直排列卡片 */
  gap: 20px; /* 增加卡片间的间距 */
  padding: 15px; /* 内边距 */
  border-radius: 10px; /* 圆角 */
  backdrop-filter: blur(10px); /* 半透明毛玻璃效果 */
  width: 350px; /* 增加卡片容器宽度 */
  z-index: 10; /* 确保卡片容器在视频上方 */
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* 卡片容器阴影 */
}

.card-info {
  background: rgba(255, 255, 255, 0.2); /* 半透明背景色 */
  border-radius: 10px; /* 圆角 */
  padding: 15px; /* 内边距 */
  display: flex;
  flex-direction: column; /* 使卡片内容垂直排列 */
  transition: background-color 0.3s ease, box-shadow 0.3s ease; /* 添加过渡效果 */
  backdrop-filter: blur(10px); /* 半透明毛玻璃效果 */
}

.card-info:hover {
  background: rgba(255, 255, 255, 0.3); /* 悬停时背景色变为更亮的白色 */
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); /* 悬停时阴影效果 */
}

.card-title {
  font-size: 18px; /* 标题字体大小 */
  font-weight: bold; /* 标题加粗 */
  margin-bottom: 10px; /* 标题和内容间距 */
  color: #333; /* 标题颜色 */
  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.4); /* 文字阴影效果 */
}

.card-table {
  width: 100%;
  border-collapse: collapse; /* 去掉表格间隙 */
  background: transparent; /* 表格背景透明 */
}

.card-table th, .card-table td {
  padding: 10px; /* 单元格内边距 */
  border: 1px solid transparent; /* 透明边框 */
  white-space: nowrap; /* 防止内容换行 */
  color: #333; /* 文本颜色 */
}

.card-table th {
  background: rgba(255, 255, 255, 0.3); /* 表头背景色 */
  font-weight: bold; /* 表头加粗 */
}

.card-table td {
  background: transparent; /* 单元格背景透明 */
  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2); /* 文字阴影效果 */
}
</style>
{% endblock stylesheets %}

{% block content %}
<div class="content">
  <div id="app" class="video-container">
    <div class="video-wrapper">
      <video ref="videoElement" v-show="showVideo" controls class="video-element"></video>
      <img src="{{ ASSETS_ROOT }}/img/video_feed.jpeg" v-show="!showVideo" alt="Video Stream" class="img-element" />
    </div>
    <div class="card-container">
      {% for drone in drones %}
      <div class="card-info">
        <div class="card-title">无人机信息</div>
        <table class="card-table">
          <tr>
            <th>无人机名称</th>
            <td>{{ drone.drone_model }}</td>
          </tr>
          <tr>
            <th>无人机编号</th>
            <td>{{ drone.drone_sn }}</td>
          </tr>
          <tr>
            <th>远程编号</th>
            <td>{{ drone.remote_sn }}</td>
          </tr>
          <tr>
            <th>工作空间ID</th>
            <td>{{ drone.workspace_id }}</td>
          </tr>
          <tr>
            <th>状态</th>
            <td>{{ drone.get_status_display }}</td>
          </tr>
          <tr>
            <th>经度</th>
            <td>{{ drone.longitude }}</td>
          </tr>
          <tr>
            <th>纬度</th>
            <td>{{ drone.latitude }}</td>
          </tr>
        </table>
      </div>
      {% endfor %}
      <div class="card-info">
        <div class="card-title">预警信息</div>
        <table class="card-table">
          <tr>
            <th>巡检通知告警</th>
            <td>有火源！</td>
          </tr>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
new Vue({
  el: '#app',
  data() {
    return {
      showVideo: false, // Initially, try to show the video. If you want to show the image, set showVideo to false.
    };
  },
  methods: {
    openFullScreen(videoUrl) {
      window.location.href = `/full_screen_video?url=${encodeURIComponent(videoUrl)}`;
    }
  },
  mounted() {
    const videoElement = this.$refs.videoElement;

    if (Hls.isSupported()) {
      const hls = new Hls();
      hls.loadSource('http://192.168.43.21/hls/stream.m3u8');
      hls.attachMedia(videoElement);
      hls.on(Hls.Events.MANIFEST_PARSED, () => {
        videoElement.play();
        this.showVideo = true; // Show the video element if HLS is supported and loaded
      });
    } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
      videoElement.src = 'http://192.168.43.21/hls/stream.m3u8';
      videoElement.addEventListener('loadedmetadata', () => {
        videoElement.play();
        this.showVideo = true; // Show the video element if the browser can play HLS natively
      });
    } else {
      // If neither HLS nor native playback is supported, show the image element
      this.showVideo = false;
    }
  }
});
</script>
{% endblock javascripts %}