{% extends "layouts/base.html" %}

{% block title %}后台管理{% endblock %}

{% block stylesheets %}
<style>
    .content {
        width: 80%;
        margin: 0 auto; /* 居中 */
        padding-top: 100px; /* 顶部空间以免被导航栏遮挡 */
    }
    .card {
        padding: 20px;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }
    table {
        width: 100%;
        border-collapse: collapse;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 8px;
    }
    th {
        background-color: #f4f4f4;
        text-align: left;
    }
    .actions {
        margin-bottom: 20px;
    }
    .video-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        object-fit: cover;
    }
</style>
{% endblock stylesheets %}

{% block content %}
<video class="video-background" autoplay loop muted>
    <source src="{{ ASSETS_ROOT }}/img/bgv.mp4" type="video/mp4">
    您的浏览器不支持视频标签。
</video>

<div class="content">
    <!-- 用户信息卡片 -->
    <div class="card">
        <h4>用户信息</h4>
        <div class="actions">
            <button class="btn btn-primary" onclick="addUser()">新增</button>
            <button class="btn btn-warning" id="editButton" onclick="editSelected()" disabled>修改</button>
            <button class="btn btn-danger" onclick="deleteSelected()">删除</button>
        </div>
        <table>
            <thead>
            <tr>
                <th><input type="checkbox" onclick="toggleAll(this)"></th>
                <th>用户名</th>
                <th>全名</th>
                <th>邮箱</th>
                <th>电话</th>
                <th>上次登录时间</th>
                <th>管理员</th>
            </tr>
            </thead>
            <tbody>
            {% for user in users %}
            <tr>
                <td><input type="checkbox" class="user-checkbox" data-id="{{ user.id }}" onchange="toggleEditButton()">
                </td>
                <td>{{ user.username }}</td>
                <td>{{ user.full_name }}</td>
                <td>{{ user.email }}</td>
                <td>{{ user.phone_number }}</td>
                <td>{{ user.last_login }}</td>
                <td>{{ user.is_admin|yesno:"是,否" }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- 历史设备卡片 -->
    <div class="card">
        <h4>历史设备</h4>
        <div class="actions">
            <button class="btn btn-primary" onclick="addDrone()">新增</button>
            <button class="btn btn-danger" onclick="deleteSelectedDrones()">删除</button>
        </div>
        <table>
            <thead>
            <tr>
                <th><input type="checkbox" onclick="toggleAllDrons(this)"></th>
                <th>无人机型号</th>
                <th>无人机序列号</th>
                <th>远程控制器序列号</th>
                <th>工作区ID</th>
                <th>设备状态</th>
                <th>用户</th>
                <th>经度</th>
                <th>纬度</th>
            </tr>
            </thead>
            <tbody>
            {% for drone in drones %}
            <tr>
                <td><input type="checkbox" class="drone-checkbox" data-id="{{ drone.id }}"
                           onchange="toggleEditDroneButton()"></td>
                <td>{{ drone.drone_model }}</td>
                <td>{{ drone.drone_sn }}</td>
                <td>{{ drone.remote_sn }}</td>
                <td>{{ drone.workspace_id }}</td>
                <td>{{ drone.status }}</td>
                <td>{{ drone.user.username }}</td>
                <td>{{ drone.longitude }}</td>
                <td>{{ drone.latitude }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- 通知信息卡片 -->
    <div class="card">
        <h4>通知信息</h4>
        <div class="actions">
            <button class="btn btn-danger" onclick="deleteSelectedNotifications()">删除</button>
        </div>
        <!-- 通知信息表格 -->
        <table id="notification-table">
            <thead>
            <tr>
                <th><input type="checkbox" onclick="toggleAllNotifications(this)"></th>
                <th>序号</th>
                <th>时间戳</th>
                <th>无人机序列号</th>
                <th>纬度</th>
                <th>经度</th>
                <th>图像源</th>
            </tr>
            </thead>
            <tbody>
            {% for notification in notifications %}
            <tr data-id="{{ notification.id }}">
                <td><input type="checkbox" class="notification-checkbox" data-drone-sn="{{ notification.DroneSN }}" data-timestamp="{{ notification.Timestamp }}"></td>
                <td>{{ forloop.counter }}</td>
                <td>{{ notification.Timestamp }}</td>
                <td>{{ notification.DroneSN }}</td>
                <td>{{ notification.Latitude }}</td>
                <td>{{ notification.Longitude }}</td>
                <td><a href="{{ notification.ImageSource }}" target="_blank">查看图像</a></td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- 模态框，用于添加用户 -->
<div class="modal fade" id="addUserModal" tabindex="-1" role="dialog" aria-labelledby="addUserModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addUserModalLabel">新增用户</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="form-group">
                        <label for="username">用户名</label>
                        <input type="text" class="form-control" id="username" name="username">
                    </div>
                    <div class="form-group">
                        <label for="full_name">全名</label>
                        <input type="text" class="form-control" id="full_name" name="full_name">
                    </div>
                    <div class="form-group">
                        <label for="email">邮箱</label>
                        <input type="email" class="form-control" id="email" name="email">
                    </div>
                    <div class="form-group">
                        <label for="phone_number">电话</label>
                        <input type="text" class="form-control" id="phone_number" name="phone_number">
                    </div>
                    <div class="form-group">
                        <label for="password">密码</label>
                        <input type="password" class="form-control" id="password" name="password">
                    </div>
                    <div class="form-group">
                        <label for="is_admin">管理员</label>
                        <select class="form-control" id="is_admin" name="is_admin">
                            <option value="false">否</option>
                            <option value="true">是</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="submitAddUser()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 修改用户模态框 -->
<div class="modal fade" id="editUserModal" tabindex="-1" role="dialog" aria-labelledby="editUserModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">修改用户</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="edit_user_id" name="id">  <!-- Hidden input to store user ID -->
                    <div class="form-group">
                        <label for="edit_username">用户名</label>
                        <input type="text" class="form-control" id="edit_username" name="username">
                    </div>
                    <div class="form-group">
                        <label for="edit_full_name">全名</label>
                        <input type="text" class="form-control" id="edit_full_name" name="full_name">
                    </div>
                    <div class="form-group">
                        <label for="edit_email">邮箱</label>
                        <input type="email" class="form-control" id="edit_email" name="email">
                    </div>
                    <div class="form-group">
                        <label for="edit_phone_number">电话</label>
                        <input type="text" class="form-control" id="edit_phone_number" name="phone_number">
                    </div>
                    <div class="form-group">
                        <label for="edit_is_admin">管理员</label>
                        <select class="form-control" id="edit_is_admin" name="is_admin">
                            <option value="false">否</option>
                            <option value="true">是</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="submitEditUser()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 新增无人机模态框 -->
<div class="modal fade" id="addDroneModal" tabindex="-1" role="dialog" aria-labelledby="addDroneModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addDroneModalLabel">添加无人机</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form method="post" action="{% url 'admin_dashboard_add_drone' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-group">
                        <label for="droneModel">无人机型号</label>
                        <select id="droneModel" name="drone_model" class="form-control" required>
                            <option value="Air 3">Air 3</option>
                            <option value="Inspire 3">Inspire 3</option>
                            <option value="Mavic 3 Classic">Mavic 3 Classic</option>
                            <option value="Mavic 3 Pro">Mavic 3 Pro</option>
                            <option value="Mini 2 SE">Mini 2 SE</option>
                            <option value="Mini 3">Mini 3</option>
                            <option value="Mini 3 Pro">Mini 3 Pro</option>
                            <option value="Mini 4 Pro">Mini 4 Pro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="droneSn">无人机序列号</label>
                        <input type="text" id="droneSn" name="drone_sn" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="remoteSn">远程控制器序列号</label>
                        <input type="text" id="remoteSn" name="remote_sn" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="workspaceId">工作区ID</label>
                        <input type="text" id="workspaceId" name="workspace_id" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="status">设备状态</label>
                        <select id="status" name="status" class="form-control" required>
                            <option value="active">在线</option>
                            <option value="inactive">离线</option>
                            <option value="maintenance">维护中</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="longitude">经度</label>
                        <input type="text" id="longitude" name="longitude" class="form-control" value="119.24547"
                               required>
                    </div>
                    <div class="form-group">
                        <label for="latitude">纬度</label>
                        <input type="text" id="latitude" name="latitude" class="form-control" value="32.26518" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                    <button type="submit" class="btn btn-primary">提交</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock content %}

{% block javascripts %}
<script>
    function toggleAll(source) {
        checkboxes = document.querySelectorAll('.user-checkbox');
        for (var i = 0; i < checkboxes.length; i++) {
            checkboxes[i].checked = source.checked;
        }
        toggleEditButton();
    }

    function toggleAllNotifications(source) {
        const checkboxes = document.querySelectorAll('.notification-checkbox');
        checkboxes.forEach(checkbox => checkbox.checked = source.checked);
    }

    function toggleEditButton() {
        var selected = document.querySelectorAll('.user-checkbox:checked');
        var editButton = document.getElementById('editButton');
        editButton.disabled = selected.length !== 1;  // 仅当选中一个时启用“修改”按钮
    }

    function addUser() {
        $('#addUserModal').modal('show');
    }

    function submitAddUser() {
        var form = document.getElementById('addUserForm');
        var formData = new FormData(form);

        fetch("{% url 'add_user' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        }).then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('添加用户失败');
            }
        });
    }
    function addDrone() {
        $('#addDroneModal').modal('show');
    }

    function editSelected() {
        console.log('editSelected function called');
        var selected = document.querySelectorAll('.user-checkbox:checked');
        if (selected.length === 1) {
            var userId = selected[0].getAttribute('data-id');

            fetch(`/users/${userId}/`)
            .then(response => response.json())
            .then(user => {
                document.getElementById('edit_user_id').value = user.id;
                document.getElementById('edit_username').value = user.username;
                document.getElementById('edit_full_name').value = user.full_name;
                document.getElementById('edit_email').value = user.email;
                document.getElementById('edit_phone_number').value = user.phone_number;
                document.getElementById('edit_is_admin').value = user.is_admin ? 'true' : 'false';
                $('#editUserModal').modal('show');
            });
        } else {
            alert('请选择一个用户进行修改');
        }
    }

    function submitEditUser() {
        var form = document.getElementById('editUserForm');
        var formData = new FormData(form);

        fetch(`/users/${formData.get('id')}/update/`, {
            method: 'POST',
            body: JSON.stringify({
                username: formData.get('username'),
                full_name: formData.get('full_name'),
                email: formData.get('email'),
                phone_number: formData.get('phone_number'),
                is_admin: formData.get('is_admin') === 'true'
            }),
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        }).then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('修改用户失败');
            }
        });
    }

    function deleteSelected() {
        var selected = [];
        document.querySelectorAll('.user-checkbox:checked').forEach(function(checkbox) {
            selected.push(checkbox.getAttribute('data-id'));
        });

        if (selected.length > 0) {
            fetch("{% url 'delete_users' %}", {
                method: 'POST',
                body: JSON.stringify({ids: selected}),
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            }).then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('删除用户失败');
                }
            });
        } else {
            alert('请选择要删除的用户');
        }
    }

    function deleteSelectedDrones() {
        var selected = document.querySelectorAll('.drone-checkbox:checked');
        var ids = Array.from(selected).map(checkbox => checkbox.getAttribute('data-id'));

        fetch("{% url 'admin_dashboard_delete_drones' %}", {
            method: 'POST',
            body: JSON.stringify({ ids: ids }),
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        }).then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('删除无人机失败');
            }
        });
    }


    function deleteSelectedNotifications() {
    const selectedCheckboxes = document.querySelectorAll('.notification-checkbox:checked');
    const notificationsToDelete = Array.from(selectedCheckboxes).map(checkbox => ({
        droneSN: checkbox.getAttribute('data-drone-sn'),
        timeStamp: checkbox.getAttribute('data-timestamp')
    }));

    if (notificationsToDelete.length === 0) {
        alert('请至少选择一个通知');
        return;
    }

    fetch('{% url "delete_notifications" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'  // Ensure you include the CSRF token for Django
        },
        body: JSON.stringify(notificationsToDelete)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('通知已删除');
            // Optionally, you can reload the page or remove the rows manually
            location.reload();  // Reload the page to reflect the changes
        } else {
            alert('删除失败');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('发生错误');
    });
}

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock javascripts %}